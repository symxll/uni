"use strict";const o=require("../../../../common/vendor.js"),p=require("../../js_sdk/uqrcode/uqrcode.js"),h=require("../../common/queue.js"),m=require("../../common/cache.js");let d=null;const v={name:"uqrcode",props:{canvasId:{type:String,required:!0},value:{type:[String,Number]},options:{type:Object,default:()=>({})},size:{type:[String,Number],default:200},sizeUnit:{type:String,default:"px"},fileType:{type:String,default:"png"},start:{type:Boolean,default:!0},auto:{type:Boolean,default:!0},hide:{type:Boolean,default:!1},type:{type:String,default:()=>"2d"},queue:{type:Boolean,default:!1},isQueueLoadImage:{type:Boolean,default:!1},loading:{type:Boolean,default:void 0},h5SaveIsDownload:{type:Boolean,default:!1},h5DownloadName:{type:String,default:"uQRCode"}},data(){return{canvas:void 0,canvasType:void 0,canvasContext:void 0,makeDelegate:void 0,drawDelegate:void 0,toTempFilePathDelegate:void 0,makeExecuted:!1,makeing:!1,drawing:!1,isError:!1,error:void 0,isH5Save:!1,tempFilePath:"",templateOptions:{size:0,width:0,height:0,canvasWidth:0,canvasHeight:0,canvasTransform:"",canvasDisplay:!1},uqrcodeOptions:{data:""},plugins:[],makeingPattern:[[[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!1,!0,!0,!0]],[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!0,!0,!0]],[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!1,!1,!1,!1,!1,!1,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]]]}},watch:{type:{handler(e){["2d"].includes(e)?this.canvasType=e:this.canvasType=void 0},immediate:!0},value:{handler(){this.auto&&this.remake()}},size:{handler(){this.auto&&this.remake()}},options:{handler(){this.auto&&this.remake()},deep:!0},makeing:{handler(e){e||typeof this.toTempFilePathDelegate=="function"&&this.toTempFilePathDelegate()}}},mounted(){this.templateOptions.size=this.sizeUnit=="rpx"?o.index.upx2px(this.size):this.size,this.templateOptions.width=this.templateOptions.size,this.templateOptions.height=this.templateOptions.size,this.templateOptions.canvasWidth=this.templateOptions.size,this.templateOptions.canvasHeight=this.templateOptions.size,this.canvasType=="2d"||(this.templateOptions.canvasTransform=`scale(${this.templateOptions.size/this.templateOptions.canvasWidth}, ${this.templateOptions.size/this.templateOptions.canvasHeight})`),this.start&&this.make()},methods:{getTemplateOptions(){var e=this.sizeUnit=="rpx"?o.index.upx2px(this.size):this.size;return c(this.templateOptions,{size:e,width:e,height:e})},getUqrcodeOptions(){return c(this.options,{data:String(this.value),size:Number(this.templateOptions.size)})},resetCanvas(e){this.templateOptions.canvasDisplay=!1,this.$nextTick(()=>{this.templateOptions.canvasDisplay=!0,this.$nextTick(()=>{e&&e()})})},async draw(e={},i=!1){if(typeof e.success!="function"&&(e.success=()=>{}),typeof e.fail!="function"&&(e.fail=()=>{}),typeof e.complete!="function"&&(e.complete=()=>{}),this.drawing){if(!i){this.drawDelegate=()=>{this.draw(e,!0)};return}}else this.drawing=!0;if(!this.canvasId){console.error("[uQRCode]: canvasId must be set!"),this.isError=!0,this.drawing=!1,e.fail({errMsg:"[uQRCode]: canvasId must be set!"}),e.complete({errMsg:"[uQRCode]: canvasId must be set!"});return}if(!this.value){console.error("[uQRCode]: value must be set!"),this.isError=!0,this.drawing=!1,e.fail({errMsg:"[uQRCode]: value must be set!"}),e.complete({errMsg:"[uQRCode]: value must be set!"});return}this.templateOptions=this.getTemplateOptions(),this.uqrcodeOptions=this.getUqrcodeOptions(),typeof this.uqrcodeOptions.errorCorrectLevel=="string"&&(this.uqrcodeOptions.errorCorrectLevel=p.b.errorCorrectLevel[this.uqrcodeOptions.errorCorrectLevel]),typeof this.options.useDynamicSize>"u"&&(this.uqrcodeOptions.useDynamicSize=!0);const t=d=new p.b;this.plugins.forEach(s=>t.register(s.plugin)),t.setOptions(this.uqrcodeOptions),t.make();let a=null;if(this.canvasType==="2d"){const s=this.canvas=await new Promise(u=>{o.index.createSelectorQuery().in(this).select(`#${this.canvasId}`).fields({node:!0,size:!0}).exec(n=>{u(n[0].node)})});a=this.canvasContext=s.getContext("2d"),this.templateOptions.canvasWidth=t.size,this.templateOptions.canvasHeight=t.size,this.templateOptions.canvasTransform="";const r=o.index.getSystemInfoSync().pixelRatio;s.width=t.dynamicSize*r,s.height=t.dynamicSize*r,a.scale(r,r),t.loadImage=this.getLoadImage(function(u){return new Promise((n,l)=>{const f=s.createImage();f.src=u,f.onload=()=>{n(f)},f.onerror=g=>{l(g)}})})}else a=this.canvasContext=o.index.createCanvasContext(this.canvasId,this),this.templateOptions.canvasWidth=t.dynamicSize,this.templateOptions.canvasHeight=t.dynamicSize,this.templateOptions.canvasTransform=`scale(${this.templateOptions.size/this.templateOptions.canvasWidth}, ${this.templateOptions.size/this.templateOptions.canvasHeight})`,t.loadImage=this.getLoadImage(function(s){return new Promise((r,u)=>{if(s.startsWith("http"))o.index.getImageInfo({src:s,success:n=>{r(n.path)},fail:n=>{u(n)}});else{if(s.startsWith("."))throw console.error("[uQRCode]: 本地图片路径仅支持绝对路径！"),new Error("[uQRCode]: local image path only supports absolute path!");r(s)}})});t.canvasContext=a,setTimeout(()=>{var s=this.plugins.find(n=>n.name==t.style),r=s?s.drawCanvas:"drawCanvas",u;this.queue?u=()=>h.queueDraw.exec(()=>t[r]()):u=()=>t[r](),u().then(()=>{if(this.drawDelegate){let n=this.drawDelegate;this.drawDelegate=void 0,n()}else this.drawing=!1,e.success()}).catch(n=>{if(console.log(n),this.drawDelegate){let l=this.drawDelegate;this.drawDelegate=void 0,l()}else this.drawing=!1,this.isError=!0,e.fail(n)}).finally(()=>{e.complete()})},300)},make(e={}){this.makeExecuted=!0,this.makeing=!0,this.isError=!1,typeof e.success!="function"&&(e.success=()=>{}),typeof e.fail!="function"&&(e.fail=()=>{}),typeof e.complete!="function"&&(e.complete=()=>{}),this.resetCanvas(()=>{clearTimeout(this.makeDelegate),this.makeDelegate=setTimeout(()=>{this.draw({success:()=>{setTimeout(()=>{e.success(),this.complete(!0)},300)},fail:i=>{e.fail(i),this.error=i,this.complete(!1,i.errMsg)},complete:()=>{e.complete(),this.makeing=!1}})},300)})},remake(e){this.$emit("change"),this.make(e)},complete(e=!0,i=""){e?this.$emit("complete",{success:e}):this.$emit("complete",{success:e,errMsg:i})},toTempFilePath(e={}){if(typeof e.success!="function"&&(e.success=()=>{}),typeof e.fail!="function"&&(e.fail=()=>{}),typeof e.complete!="function"&&(e.complete=()=>{}),!this.makeExecuted){console.error("[uQRCode]: make() 方法从未调用！请先成功调用 make() 后再进行操作。");var i={errMsg:"[uQRCode]: make() method has never been executed! please execute make() successfully before operating."};e.fail(i),e.complete(i);return}if(this.isError){e.fail(this.error),e.complete(this.error);return}if(this.makeing){this.toTempFilePathDelegate=()=>{this.toTempFilePath(e)};return}else this.toTempFilePathDelegate=null;if(this.canvasType==="2d")try{let t=null;t=o.toRaw(this.canvas).toDataURL(),e.success({tempFilePath:t}),e.complete({tempFilePath:t})}catch(t){e.fail(t),e.complete(t)}else o.index.canvasToTempFilePath({canvasId:this.canvasId,fileType:this.fileType,width:Number(this.templateOptions.canvasWidth),height:Number(this.templateOptions.canvasHeight),destWidth:Number(this.templateOptions.size),destHeight:Number(this.templateOptions.size),success:t=>{e.success(t)},fail:t=>{e.fail(t)},complete:()=>{e.complete()}},this)},save(e={}){typeof e.success!="function"&&(e.success=()=>{}),typeof e.fail!="function"&&(e.fail=()=>{}),typeof e.complete!="function"&&(e.complete=()=>{}),this.toTempFilePath({success:i=>{if(this.canvasType==="2d"){const t=new RegExp("^data:image/png;base64,","g"),a=i.tempFilePath.replace(t,""),s=o.wx$1.getFileSystemManager(),r=`${o.wx$1.env.USER_DATA_PATH}/${new Date().getTime()}${Math.random().toString().split(".")[1]}.png`;s.writeFile({filePath:r,data:a,encoding:"base64",success:u=>{o.index.saveImageToPhotosAlbum({filePath:r,success:n=>{e.success(n)},fail:n=>{e.fail(n)},complete:()=>{e.complete()}})},fail:u=>{e.fail(u)},complete:()=>{e.complete()}})}else o.index.saveImageToPhotosAlbum({filePath:i.tempFilePath,success:t=>{e.success(t)},fail:t=>{e.fail(t)},complete:()=>{e.complete()}})},fail:i=>{e.fail(i),e.complete(i)}})},onClick(e){this.$emit("click",e)},getInstance(){return d},registerStyle(e){if(e.Type!="style")return console.warn("[uQRCode]: registerStyle 仅支持注册 style 类型的扩展！"),{errMsg:"registerStyle 仅支持注册 style 类型的扩展！"};typeof e=="function"&&this.plugins.push({plugin:e,name:e.Name,drawCanvas:e.DrawCanvas})},getLoadImage(e){var i=this;return typeof e=="function"?function(t){return i.isQueueLoadImage?h.queueLoadImage.exec(()=>new Promise((a,s)=>{setTimeout(()=>{const r=m.cacheImageList.find(u=>u.src==t);r?a(r.img):e(t).then(u=>{m.cacheImageList.push({src:t,img:u}),a(u)}).catch(u=>{s(u)})},10)})):e(t)}:function(t){return Promise.resolve(t)}}}};function c(e={},i={},t=!1){let a;t?a=e:a={...e};for(let r in i){var s=i[r];s!=null&&(s.constructor==Object?a[r]=this.deepReplace(a[r],s):s.constructor==String&&!s?a[r]=a[r]:a[r]=s)}return a}function y(e,i,t,a,s,r){return o.e({a:s.templateOptions.canvasDisplay},s.templateOptions.canvasDisplay?{b:t.canvasId,c:t.canvasId,d:s.canvasType,e:`${s.templateOptions.canvasWidth}px`,f:`${s.templateOptions.canvasHeight}px`,g:s.templateOptions.canvasTransform,h:o.o((...u)=>r.onClick&&r.onClick(...u))}:{},{i:t.loading===void 0?s.makeing:t.loading},(t.loading===void 0?s.makeing:t.loading)?{j:`${s.templateOptions.size/4}px`,k:`${s.templateOptions.size/4}px`}:{},{l:s.isError},s.isError?{m:o.t(s.error.errMsg),n:o.r("error",{error:s.error}),o:o.o((...u)=>r.onClick&&r.onClick(...u))}:{},{p:t.hide?1:"",q:`${s.templateOptions.width}px`,r:`${s.templateOptions.height}px`})}const O=o._export_sfc(v,[["render",y],["__scopeId","data-v-42fcb7aa"]]);wx.createComponent(O);
